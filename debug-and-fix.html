<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug & Fix - GENESIS</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .section { 
            margin-bottom: 30px; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: #f9f9f9; 
        }
        .section h3 { 
            color: #333; 
            margin-top: 0; 
        }
        .data { 
            background: #fff; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 11px; 
            overflow-x: auto; 
            white-space: pre-wrap; 
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            margin: 5px; 
        }
        button:hover { 
            opacity: 0.9; 
        }
        button.danger {
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
        }
        button.success {
            background: linear-gradient(135deg, #00ff88 0%, #00d46a 100%);
        }
        .result { 
            margin-top: 15px; 
            padding: 10px; 
            border-radius: 5px; 
            font-weight: 600; 
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug & Fix Tool</h1>
        <p>This tool will diagnose and fix authentication issues with your GENESIS app.</p>

        <div class="section">
            <h3>üîç Step 1: Analyze Current Data</h3>
            <div class="grid">
                <button onclick="showAllLocalStorage()">Show ALL LocalStorage</button>
                <button onclick="analyzeSpecificData()">Analyze User Data</button>
            </div>
            <div id="dataAnalysis"></div>
        </div>

        <div class="section">
            <h3>üë§ Step 2: Create Jordan Profile</h3>
            <p>Let's manually create the jordan profile and associate it with your wallet.</p>
            <div class="grid">
                <button onclick="createJordanProfile()">Create Jordan Profile</button>
                <button onclick="connectWalletAndAssociate()" class="success">Connect Wallet + Associate</button>
            </div>
            <div id="jordanResult"></div>
        </div>

        <div class="section">
            <h3>üß™ Step 3: Test Authentication</h3>
            <div class="grid">
                <button onclick="testWalletConnection()">Test Wallet Connection</button>
                <button onclick="testProfileSetup()">Test Profile Setup Page</button>
            </div>
            <div id="testResults"></div>
        </div>

        <div class="section">
            <h3>üóëÔ∏è Step 4: Reset if Needed</h3>
            <div class="grid">
                <button onclick="clearAllData()" class="danger">Clear All Data</button>
                <button onclick="resetToFresh()" class="danger">Fresh Start</button>
            </div>
            <div id="resetResults"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config/api-keys.js"></script>
    <script src="js/moralis-auth.js"></script>
    
    <script>
        function addResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            element.appendChild(resultDiv);
        }

        function addData(elementId, title, data) {
            const element = document.getElementById(elementId);
            const titleDiv = document.createElement('div');
            titleDiv.className = 'result info';
            titleDiv.textContent = title;
            element.appendChild(titleDiv);
            
            const dataDiv = document.createElement('div');
            dataDiv.className = 'data';
            dataDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            element.appendChild(dataDiv);
        }

        function showAllLocalStorage() {
            const element = document.getElementById('dataAnalysis');
            element.innerHTML = '';

            addResult('dataAnalysis', 'Showing ALL LocalStorage contents:', 'info');
            
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    const value = localStorage.getItem(key);
                    allData[key] = JSON.parse(value);
                } catch (e) {
                    allData[key] = value;
                }
            }
            
            addData('dataAnalysis', 'Complete LocalStorage', allData);
        }

        function analyzeSpecificData() {
            const element = document.getElementById('dataAnalysis');
            element.innerHTML = '';

            try {
                // Check specific keys
                const siweUsers = JSON.parse(localStorage.getItem('siwe_users') || '{}');
                const userWorlds = JSON.parse(localStorage.getItem('user_worlds') || '{}');
                const moralisSession = localStorage.getItem('moralis_session');

                addResult('dataAnalysis', `SIWE Users: ${Object.keys(siweUsers).length} found`, 'info');
                addData('dataAnalysis', 'siwe_users', siweUsers);

                addResult('dataAnalysis', `User Worlds: ${Object.keys(userWorlds).length} users`, 'info');
                addData('dataAnalysis', 'user_worlds', userWorlds);

                if (moralisSession) {
                    addResult('dataAnalysis', 'Moralis Session: Found', 'success');
                    addData('dataAnalysis', 'moralis_session', JSON.parse(moralisSession));
                } else {
                    addResult('dataAnalysis', 'Moralis Session: Not found', 'warning');
                }

                // Look for jordan specifically
                let jordanFound = false;
                for (const [key, userData] of Object.entries(siweUsers)) {
                    if (userData.username === 'jordan' || key === 'jordan') {
                        addResult('dataAnalysis', `‚úÖ Jordan profile found under key: ${key}`, 'success');
                        addData('dataAnalysis', 'Jordan Profile', userData);
                        jordanFound = true;
                        break;
                    }
                }

                if (!jordanFound) {
                    addResult('dataAnalysis', '‚ùå Jordan profile NOT found', 'error');
                }

            } catch (error) {
                addResult('dataAnalysis', `Error: ${error.message}`, 'error');
            }
        }

        function createJordanProfile() {
            const element = document.getElementById('jordanResult');
            element.innerHTML = '';

            try {
                // Create jordan profile
                const jordanProfile = {
                    id: 'user_jordan_' + Date.now(),
                    walletAddress: null, // Will be set when wallet connects
                    username: 'jordan',
                    displayName: 'jordan',
                    bio: 'GENESIS creator and tester',
                    profileImage: null,
                    isVerified: false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    worlds: [],
                    preferences: { 
                        theme: 'dark', 
                        notifications: true, 
                        analytics: true 
                    },
                    profileComplete: true
                };

                // Save to localStorage
                const users = JSON.parse(localStorage.getItem('siwe_users') || '{}');
                users['jordan'] = jordanProfile;
                localStorage.setItem('siwe_users', JSON.stringify(users));

                addResult('jordanResult', '‚úÖ Jordan profile created successfully!', 'success');
                addData('jordanResult', 'Created Profile', jordanProfile);

            } catch (error) {
                addResult('jordanResult', `Error: ${error.message}`, 'error');
            }
        }

        async function connectWalletAndAssociate() {
            const element = document.getElementById('jordanResult');
            element.innerHTML = '';

            try {
                addResult('jordanResult', 'Connecting wallet...', 'info');

                // Wait for wallet manager
                if (!window.walletManager) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                if (!window.walletManager) {
                    throw new Error('Wallet manager not available');
                }

                // Authenticate
                const result = await window.walletManager.authenticate();
                
                if (!result.success) {
                    throw new Error(result.error);
                }

                const walletAddress = window.walletManager.account;
                addResult('jordanResult', `‚úÖ Wallet connected: ${walletAddress}`, 'success');

                // Associate with jordan profile
                const users = JSON.parse(localStorage.getItem('siwe_users') || '{}');
                
                // Create jordan profile if it doesn't exist
                if (!users['jordan']) {
                    users['jordan'] = {
                        id: 'user_jordan_' + Date.now(),
                        username: 'jordan',
                        displayName: 'jordan',
                        bio: 'GENESIS creator and tester',
                        profileImage: null,
                        isVerified: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        worlds: [],
                        preferences: { 
                            theme: 'dark', 
                            notifications: true, 
                            analytics: true 
                        },
                        profileComplete: true
                    };
                }

                // Associate with wallet
                users['jordan'].walletAddress = walletAddress;
                users['jordan'].updatedAt = new Date().toISOString();
                
                // Save under wallet address as key too
                users[walletAddress] = users['jordan'];
                
                localStorage.setItem('siwe_users', JSON.stringify(users));

                // Update current user in wallet manager
                window.walletManager.updateUser({
                    username: 'jordan',
                    bio: 'GENESIS creator and tester',
                    displayName: 'jordan'
                });

                addResult('jordanResult', 'üéâ Jordan profile successfully associated with wallet!', 'success');
                addResult('jordanResult', 'You can now access dashboard and my-worlds!', 'success');

            } catch (error) {
                addResult('jordanResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testWalletConnection() {
            const element = document.getElementById('testResults');
            element.innerHTML = '';

            try {
                if (!window.walletManager) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                if (window.walletManager) {
                    addResult('testResults', `Wallet Manager: Available`, 'success');
                    addResult('testResults', `Authenticated: ${window.walletManager.isAuthenticated}`, 'info');
                    addResult('testResults', `Connected: ${window.walletManager.isConnected}`, 'info');
                    addResult('testResults', `Account: ${window.walletManager.account || 'None'}`, 'info');
                    
                    const user = window.walletManager.getCurrentUser();
                    if (user) {
                        addResult('testResults', `Username: ${user.username || 'None'}`, 'info');
                        addData('testResults', 'Current User', user);
                    }
                } else {
                    addResult('testResults', 'Wallet Manager: Not Available', 'error');
                }
            } catch (error) {
                addResult('testResults', `Error: ${error.message}`, 'error');
            }
        }

        function testProfileSetup() {
            const element = document.getElementById('testResults');
            addResult('testResults', 'Opening profile setup page...', 'info');
            window.open('profile-setup.html', '_blank');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL localStorage data? This cannot be undone.')) {
                localStorage.clear();
                addResult('resetResults', 'üóëÔ∏è All localStorage data cleared', 'success');
            }
        }

        function resetToFresh() {
            if (confirm('Reset to completely fresh state? This will clear all data and disconnect wallet.')) {
                localStorage.clear();
                if (window.walletManager) {
                    window.walletManager.clearSession();
                }
                addResult('resetResults', 'üîÑ Reset to fresh state complete', 'success');
                addResult('resetResults', 'Refresh the page to start over', 'info');
            }
        }
    </script>
</body>
</html>