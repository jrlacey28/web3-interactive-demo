<!DOCTYPE html>
<html>
<head>
    <title>Simple Username Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        button { padding: 15px 25px; margin: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>🔧 Simple Username Fix</h1>
    
    <div class="section">
        <h3>Current Storage Status</h3>
        <button onclick="showAllData()">Show All Data</button>
        <button onclick="fixJordanConnection()">Fix Jordan Connection</button>
        <button onclick="testWalletDisplay()">Test Wallet Display</button>
        <div id="output"></div>
    </div>

    <div class="section">
        <h3>Manual Steps</h3>
        <p>If automatic fixing doesn't work, do this manually:</p>
        <ol>
            <li>Open browser console (F12)</li>
            <li>Run: <code>localStorage.setItem('siwe_users', JSON.stringify({jordan: {username: 'jordan', walletAddress: 'YOUR_WALLET_ADDRESS', displayName: 'Jordan'}}))</code></li>
            <li>Replace YOUR_WALLET_ADDRESS with your actual address</li>
            <li>Refresh page</li>
        </ol>
    </div>

    <script>
        // Simple wallet object for testing
        const testWallet = {
            account: null,
            connected: false,
            
            // Simulate wallet connection
            connect() {
                // In real app, this would use MetaMask
                this.account = prompt('Enter your wallet address:');
                if (this.account) {
                    this.connected = true;
                    addOutput('✅ Test wallet connected: ' + this.account, 'success');
                    return { success: true, account: this.account };
                }
                return { success: false, error: 'No address provided' };
            },
            
            getShortAddress() {
                if (!this.account) return '';
                return `${this.account.slice(0, 6)}...${this.account.slice(-4)}`;
            },
            
            checkUsernameAssociation() {
                try {
                    const users = JSON.parse(localStorage.getItem('siwe_users') || '{}');
                    const walletAddress = this.account.toLowerCase();
                    
                    for (const [username, userData] of Object.entries(users)) {
                        if (userData.walletAddress && userData.walletAddress.toLowerCase() === walletAddress) {
                            addOutput(`✅ Found username "${username}" for wallet`, 'success');
                            return username;
                        }
                    }
                    
                    addOutput('⚠️ No username found for wallet', 'error');
                    return null;
                } catch (error) {
                    addOutput('❌ Error: ' + error.message, 'error');
                    return null;
                }
            },
            
            getDisplayName() {
                const users = JSON.parse(localStorage.getItem('siwe_users') || '{}');
                const walletAddress = this.account ? this.account.toLowerCase() : null;
                
                if (!walletAddress) return null;
                
                for (const [username, userData] of Object.entries(users)) {
                    if (userData.walletAddress && userData.walletAddress.toLowerCase() === walletAddress) {
                        return userData.displayName || username;
                    }
                }
                return null;
            }
        };

        function addOutput(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            document.getElementById('output').appendChild(div);
        }

        function showAllData() {
            document.getElementById('output').innerHTML = '';
            
            addOutput('📊 Checking all localStorage data...', 'info');
            
            // Show siwe_users
            const users = localStorage.getItem('siwe_users');
            if (users) {
                addOutput('siwe_users found:', 'success');
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(JSON.parse(users), null, 2);
                document.getElementById('output').appendChild(pre);
            } else {
                addOutput('❌ No siwe_users found', 'error');
            }
            
            // Show wallet sessions
            const sessions = ['genesis_wallet_session', 'web3_session', 'wallet_session'];
            sessions.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    addOutput(`${key} found:`, 'info');
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(JSON.parse(data), null, 2);
                    document.getElementById('output').appendChild(pre);
                }
            });
        }

        function fixJordanConnection() {
            document.getElementById('output').innerHTML = '';
            
            // Connect test wallet
            const result = testWallet.connect();
            if (!result.success) {
                addOutput('❌ Failed to connect wallet', 'error');
                return;
            }
            
            const walletAddress = testWallet.account.toLowerCase();
            
            // Create Jordan profile
            const users = JSON.parse(localStorage.getItem('siwe_users') || '{}');
            users['jordan'] = {
                username: 'jordan',
                walletAddress: walletAddress,
                displayName: 'Jordan',
                bio: 'Creator on GENESIS',
                createdAt: new Date().toISOString(),
                verified: true
            };
            
            localStorage.setItem('siwe_users', JSON.stringify(users));
            addOutput('✅ Created Jordan profile in siwe_users', 'success');
            
            // Create wallet session
            const session = {
                account: testWallet.account,
                chainId: '0x66eee',
                signature: 'manual_link',
                authenticatedAt: new Date().toISOString(),
                username: 'jordan',
                displayName: 'Jordan'
            };
            
            localStorage.setItem('genesis_wallet_session', JSON.stringify(session));
            addOutput('✅ Created wallet session with Jordan link', 'success');
            
            // Test the connection
            testWalletDisplay();
        }

        function testWalletDisplay() {
            if (!testWallet.account) {
                addOutput('⚠️ Connect wallet first', 'error');
                return;
            }
            
            addOutput('🧪 Testing wallet display logic...', 'info');
            
            const username = testWallet.checkUsernameAssociation();
            const displayName = testWallet.getDisplayName();
            const shortAddress = testWallet.getShortAddress();
            
            addOutput(`Username found: ${username}`, username ? 'success' : 'error');
            addOutput(`Display name: ${displayName}`, displayName ? 'success' : 'error');
            addOutput(`Short address: ${shortAddress}`, 'info');
            
            // Show what the wallet button should display
            const buttonText = displayName ? `${displayName} (${shortAddress})` : shortAddress;
            addOutput(`Wallet button should show: "${buttonText}"`, 'success');
            
            // Show copy-paste code for manual fix
            addOutput('📋 Manual fix code:', 'info');
            const code = `localStorage.setItem('siwe_users', '${JSON.stringify({jordan: {username: 'jordan', walletAddress: testWallet.account.toLowerCase(), displayName: 'Jordan'}})}');`;
            const pre = document.createElement('pre');
            pre.textContent = code;
            pre.style.fontSize = '12px';
            pre.style.background = '#fff3cd';
            document.getElementById('output').appendChild(pre);
        }

        // Auto-show data on load
        window.addEventListener('load', () => {
            showAllData();
        });
    </script>
</body>
</html>