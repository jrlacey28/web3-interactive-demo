<!DOCTYPE html>
<html>
<head>
    <title>Debug User Storage</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîç User Storage Debug</h1>
    
    <div class="section">
        <h3>Current User Data in localStorage</h3>
        <button onclick="showUsers()">Show Stored Users</button>
        <button onclick="showSessions()">Show Sessions</button>
        <button onclick="clearAll()">Clear All Data</button>
        <pre id="userData"></pre>
    </div>

    <div class="section">
        <h3>Reconnect Jordan to Current Wallet</h3>
        <p>Current Wallet: <span id="currentWallet">Not connected</span></p>
        <button onclick="connectWallet()">Connect Wallet</button>
        <button onclick="linkToJordan()">Link to Jordan Username</button>
        <pre id="result"></pre>
    </div>

    <script src="js/simple-wallet-connection.js"></script>
    <script>
        function showUsers() {
            const users = JSON.parse(localStorage.getItem('siwe_users') || '{}');
            document.getElementById('userData').textContent = 
                'siwe_users:\n' + JSON.stringify(users, null, 2);
        }

        function showSessions() {
            const sessions = [
                'genesis_wallet_session',
                'web3_session', 
                'moralis_session',
                'wallet_session'
            ];
            
            let output = '';
            sessions.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    output += `${key}:\n${JSON.stringify(JSON.parse(data), null, 2)}\n\n`;
                }
            });
            
            document.getElementById('userData').textContent = output || 'No sessions found';
        }

        function clearAll() {
            if (confirm('Clear all user data? This cannot be undone.')) {
                localStorage.clear();
                document.getElementById('userData').textContent = 'All data cleared';
                document.getElementById('result').textContent = '';
            }
        }

        async function connectWallet() {
            try {
                const result = await window.genesisWallet.connect();
                if (result.success) {
                    await window.genesisWallet.authenticate();
                    document.getElementById('currentWallet').textContent = window.genesisWallet.account;
                    document.getElementById('result').textContent = 'Wallet connected: ' + window.genesisWallet.account;
                } else {
                    document.getElementById('result').textContent = 'Connection failed: ' + result.error;
                }
            } catch (error) {
                document.getElementById('result').textContent = 'Error: ' + error.message;
            }
        }

        function linkToJordan() {
            if (!window.genesisWallet || !window.genesisWallet.account) {
                document.getElementById('result').textContent = 'Please connect wallet first';
                return;
            }

            const walletAddress = window.genesisWallet.account.toLowerCase();
            
            // Create or update Jordan's profile
            const users = JSON.parse(localStorage.getItem('siwe_users') || '{}');
            
            // Create Jordan profile linked to current wallet
            users['jordan'] = {
                username: 'jordan',
                walletAddress: walletAddress,
                displayName: 'Jordan',
                bio: 'Creator on GENESIS',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                verified: true
            };
            
            // Save updated users
            localStorage.setItem('siwe_users', JSON.stringify(users));
            
            // Update wallet session with username
            const session = {
                account: window.genesisWallet.account,
                chainId: window.genesisWallet.chainId,
                signature: 'manual_link',
                authenticatedAt: new Date().toISOString(),
                username: 'jordan',
                displayName: 'Jordan'
            };
            
            localStorage.setItem('genesis_wallet_session', JSON.stringify(session));
            
            // Force wallet to check username association
            if (window.genesisWallet.checkUsernameAssociation) {
                const foundUsername = window.genesisWallet.checkUsernameAssociation();
                document.getElementById('result').textContent = 
                    `‚úÖ Linked wallet ${window.genesisWallet.getShortAddress()} to "jordan"\n` +
                    `Found username: ${foundUsername}\n` +
                    `Display name: ${window.genesisWallet.getDisplayName()}`;
            } else {
                document.getElementById('result').textContent = 
                    `‚úÖ Linked wallet ${window.genesisWallet.getShortAddress()} to "jordan"`;
            }
            
            // Update wallet UI
            if (window.genesisWallet.updateWalletUI) {
                window.genesisWallet.updateWalletUI();
            }
            
            // Show updated data
            showUsers();
        }

        // Auto-show data on load
        window.addEventListener('load', () => {
            showUsers();
            if (window.genesisWallet && window.genesisWallet.account) {
                document.getElementById('currentWallet').textContent = window.genesisWallet.account;
            }
        });
    </script>
</body>
</html>