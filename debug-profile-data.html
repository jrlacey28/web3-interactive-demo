<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Profile Data</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            padding: 20px; 
            background: #f5f5f5; 
            max-width: 1200px;
            margin: 0 auto;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px;
        }
        .data-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            margin: 10px 5px;
            font-size: 16px;
        }
        .fix-btn {
            background: #28a745;
        }
        .clear-btn {
            background: #dc3545;
        }
        h1 { color: #333; }
        h2 { color: #555; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Profile Data Debug Tool</h1>
        <p>This tool helps diagnose profile data issues and wallet connections.</p>
        
        <button onclick="debugAll()">üîç Debug All Data</button>
        <button onclick="fixJordanProfile()" class="fix-btn">üîß Fix Jordan Profile Connection</button>
        <button onclick="clearAllData()" class="clear-btn">üßπ Clear All Data</button>
    </div>
    
    <div class="container">
        <h2>üîó Current Wallet State</h2>
        <div id="walletState" class="data-section">Click "Debug All Data" to load...</div>
    </div>
    
    <div class="container">
        <h2>üë§ User Data Storage</h2>
        <div id="userData" class="data-section">Click "Debug All Data" to load...</div>
    </div>
    
    <div class="container">
        <h2>üíæ All Storage Keys</h2>
        <div id="storageKeys" class="data-section">Click "Debug All Data" to load...</div>
    </div>
    
    <div class="container">
        <h2>üîß Actions</h2>
        <button onclick="testWalletConnection()">üîó Test Wallet Connection</button>
        <button onclick="forceJordanUsername()">‚úèÔ∏è Force Set Username to 'jordan'</button>
        <button onclick="associateCurrentWallet()">üîó Associate Current Wallet with Jordan</button>
    </div>

    <!-- Scripts -->
    <script src="config/api-keys.js"></script>
    <script src="js/persistent-wallet.js"></script>
    <script src="js/moralis-auth.js"></script>
    
    <script>
        function debugAll() {
            console.log('üîç Starting comprehensive debug...');
            
            // Debug wallet state
            debugWalletState();
            debugUserData();
            debugStorageKeys();
        }
        
        function debugWalletState() {
            const container = document.getElementById('walletState');
            
            try {
                const state = {
                    // Global wallet state
                    WALLET_STATE: window.WALLET_STATE,
                    
                    // Persistent wallet manager
                    persistentWallet: window.persistentWallet ? {
                        isConnected: window.persistentWallet.isConnected,
                        isAuthenticated: window.persistentWallet.isAuthenticated,
                        account: window.persistentWallet.account,
                        username: window.persistentWallet.username,
                        getCurrentUser: window.persistentWallet.getCurrentUser()
                    } : 'Not available',
                    
                    // Legacy wallet manager
                    walletManager: window.walletManager ? {
                        isConnected: window.walletManager.isConnected,
                        isAuthenticated: window.walletManager.isAuthenticated,
                        account: window.walletManager.account,
                        getCurrentUser: window.walletManager.getCurrentUser ? window.walletManager.getCurrentUser() : 'Method not available'
                    } : 'Not available'
                };
                
                container.textContent = JSON.stringify(state, null, 2);
                
            } catch (error) {
                container.textContent = 'Error reading wallet state: ' + error.message;
            }
        }
        
        function debugUserData() {
            const container = document.getElementById('userData');
            
            try {
                const userData = {
                    siwe_users: JSON.parse(localStorage.getItem('siwe_users') || '{}'),
                    genesis_user_data: localStorage.getItem('genesis_user_data'),
                    moralis_session: localStorage.getItem('moralis_session'),
                    vercel_auth: localStorage.getItem('vercel_auth'),
                    genesis_wallet_session: localStorage.getItem('genesis_wallet_session')
                };
                
                container.textContent = JSON.stringify(userData, null, 2);
                
            } catch (error) {
                container.textContent = 'Error reading user data: ' + error.message;
            }
        }
        
        function debugStorageKeys() {
            const container = document.getElementById('storageKeys');
            
            try {
                const allKeys = {
                    localStorageKeys: Object.keys(localStorage).sort(),
                    sessionStorageKeys: Object.keys(sessionStorage).sort(),
                    walletRelatedKeys: Object.keys(localStorage).filter(key => 
                        key.includes('wallet') || 
                        key.includes('auth') || 
                        key.includes('genesis') || 
                        key.includes('moralis') ||
                        key.includes('siwe') ||
                        key.includes('jordan')
                    )
                };
                
                container.textContent = JSON.stringify(allKeys, null, 2);
                
            } catch (error) {
                container.textContent = 'Error reading storage keys: ' + error.message;
            }
        }
        
        function fixJordanProfile() {
            try {
                console.log('üîß Attempting to fix Jordan profile connection...');
                
                // Get current wallet address
                const currentAddress = window.persistentWallet?.account || window.WALLET_STATE?.account;
                
                if (!currentAddress) {
                    alert('‚ùå No wallet connected. Please connect your wallet first.');
                    return;
                }
                
                // Create/update Jordan profile
                const users = JSON.parse(localStorage.getItem('siwe_users') || '{}');
                
                // Update the current wallet address with jordan profile
                users[currentAddress] = {
                    walletAddress: currentAddress,
                    username: 'jordan',
                    bio: 'Jordan\'s profile - creator and developer',
                    displayName: 'Jordan',
                    createdAt: users[currentAddress]?.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    authenticated: true
                };
                
                localStorage.setItem('siwe_users', JSON.stringify(users));
                
                // Update persistent wallet state
                if (window.persistentWallet) {
                    window.persistentWallet.updateUser({
                        username: 'jordan',
                        bio: 'Jordan\'s profile - creator and developer',
                        displayName: 'Jordan'
                    });
                }
                
                alert('‚úÖ Jordan profile connection fixed! Please refresh the page.');
                console.log('‚úÖ Jordan profile updated:', users[currentAddress]);
                
            } catch (error) {
                console.error('‚ùå Failed to fix Jordan profile:', error);
                alert('‚ùå Failed to fix profile: ' + error.message);
            }
        }
        
        function forceJordanUsername() {
            const currentAddress = window.persistentWallet?.account || window.WALLET_STATE?.account;
            
            if (!currentAddress) {
                alert('‚ùå No wallet connected');
                return;
            }
            
            // Force update all storage locations
            const sessionData = {
                address: currentAddress,
                username: 'jordan',
                bio: 'Jordan\'s profile - creator and developer',
                displayName: 'Jordan',
                authenticated: true,
                timestamp: Date.now()
            };
            
            // Update all storage locations
            localStorage.setItem('genesis_wallet_session', JSON.stringify(sessionData));
            localStorage.setItem('genesis_auth_data', JSON.stringify(sessionData));
            sessionStorage.setItem('genesis_wallet_session', JSON.stringify(sessionData));
            
            // Update users database
            const users = JSON.parse(localStorage.getItem('siwe_users') || '{}');
            users[currentAddress] = {
                walletAddress: currentAddress,
                username: 'jordan',
                bio: 'Jordan\'s profile - creator and developer',
                displayName: 'Jordan',
                authenticated: true
            };
            localStorage.setItem('siwe_users', JSON.stringify(users));
            
            alert('‚úÖ Username forced to "jordan". Refresh the page.');
        }
        
        function associateCurrentWallet() {
            if (!window.persistentWallet?.isConnected) {
                alert('‚ùå Please connect your wallet first');
                return;
            }
            
            const address = window.persistentWallet.account;
            console.log('üîó Associating wallet', address, 'with jordan profile');
            
            fixJordanProfile();
        }
        
        function testWalletConnection() {
            if (window.persistentWallet) {
                alert('Wallet Manager Status:\\n' +
                      'Connected: ' + window.persistentWallet.isConnected + '\\n' +
                      'Authenticated: ' + window.persistentWallet.isAuthenticated + '\\n' +
                      'Account: ' + window.persistentWallet.account + '\\n' +
                      'Username: ' + window.persistentWallet.username);
            } else {
                alert('‚ùå Persistent wallet manager not available');
            }
        }
        
        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will clear ALL data and sign you out. Continue?')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('üßπ All data cleared. Please refresh the page.');
            }
        }
        
        // Auto-load on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(debugAll, 1000);
        });
    </script>
</body>
</html>